@page "/Data"
@using AccreditValidation.Shared.Constants
@using Components

<AuthWrapper>
    <div class="settings-container @AppState.CustomBackgroundClass" id="data_holder_container" @ref="data_holder_container">

        <!-- ── Stats card ──────────────────────────────────────────────────── -->
        <div class="settings-card">
            <div class="info-row">
                <span class="info-label">@LocalizationService["TotalScans"]</span>
                <span class="info-value">@AppState.TotalScans</span>
            </div>
            <div class="row-divider"></div>

            <div class="info-row">
                <span class="info-label">@LocalizationService["TotalOfflineRecords"]</span>
                <span class="info-value">@AppState.TotalOfflineRecords</span>
            </div>
            <div class="row-divider"></div>

            <div class="info-row">
                <span class="info-label">@LocalizationService["LastOfflineSync"]</span>
                <span class="info-value info-value--muted">@AppState.LastOfflineSync</span>
            </div>
            <div class="row-divider"></div>

            <div class="info-row">
                <span class="info-label">@LocalizationService["NetworkStatus"]</span>
                <span class="network-status-row">
                    <span class="status-dot @(AppState.NetworkStatus == ConstantsName.Online ? "status-dot--online" : "status-dot--offline")"></span>
                    <span class="status-label @(AppState.NetworkStatus == ConstantsName.Online ? "status-label--online" : "status-label--offline")">
                        @AppState.NetworkStatus
                    </span>
                </span>
            </div>
        </div>

        <!-- ── Actions card ────────────────────────────────────────────────── -->
        <div class="settings-card">
            <button class="btn-link-row" @onclick="SyncData">
                <i class="bi bi-arrow-repeat btn-link-icon"></i>
                <span>@LocalizationService["SyncData"]</span>
                <i class="bi bi-chevron-right btn-link-chevron"></i>
            </button>
            <div class="row-divider"></div>

            <button class="btn-link-row" @onclick="LoadOfflineScans">
                <i class="bi bi-eye btn-link-icon"></i>
                <span>@LocalizationService["ViewOfflineScans"]</span>
                <i class="bi bi-chevron-right btn-link-chevron"></i>
            </button>
            <div class="row-divider"></div>

            <button class="btn-link-row" @onclick="DownloadData">
                <i class="bi bi-download btn-link-icon"></i>
                <span>@LocalizationService["DownloadData"]</span>
                <i class="bi bi-chevron-right btn-link-chevron"></i>
            </button>
            <div class="row-divider"></div>

            <button class="btn-link-row" @onclick="ToggleNetworkMode">
                <i class="bi @(AppState.NetworkStatus == ConstantsName.Online ? "bi-wifi-off" : "bi-wifi") btn-link-icon"></i>
                <span>
                    @if (AppState.NetworkStatus == ConstantsName.Online)
                    {
                        @LocalizationService["OfflineMode"]
                    }
                    else
                    {
                        @LocalizationService["OnlineMode"]
                    }
                </span>
                <i class="bi bi-chevron-right btn-link-chevron"></i>
            </button>
            <div class="row-divider"></div>

            <button class="btn-danger-row" @onclick="DeleteDatabase">
                <i class="bi bi-trash"></i>
                <span>@LocalizationService["DeleteDatabase"]</span>
            </button>
        </div>

        <!-- ── Confirm Delete DB Dialog ────────────────────────────────────── -->
        @if (showConfirmDeleteDatabaseDialog)
        {
            <div class="modal-overlay">
                <div class="modal-window">
                    <h2 class="modal-title">@LocalizationService["ConfirmDeleteDatabaseTitle"]</h2>
                    <p class="modal-message">@LocalizationService["ConfirmDeleteDatabaseMessage"]</p>
                    <div class="modal-actions">
                        <button class="modal-btn modal-btn-cancel" @onclick="() => ConfirmDelete(false)">@LocalizationService["Cancel"]</button>
                        <button class="modal-btn modal-btn-confirm" @onclick="() => ConfirmDelete(true)">@LocalizationService["OK"]</button>
                    </div>
                </div>
            </div>
        }

        <!-- ── Download Data Dialog ─────────────────────────────────────────── -->
        @if (showConfirmDownloadDataDialog)
        {
            <div class="modal-overlay">
                <div class="modal-window">
                    <h2 class="modal-title">@LocalizationService["DownloadData"]</h2>
                    <div class="modal-option-group">
                        <button class="modal-option-btn" @onclick="() => ConfirmDownloadData(true, false)">
                            @LocalizationService["ConfirmDownloadDataMessageWithoutPhotos"]
                        </button>
                        <button class="modal-option-btn" @onclick="() => ConfirmDownloadData(true, true)">
                            @LocalizationService["ConfirmDownloadDataMessageWithPhotos"]
                        </button>
                    </div>
                    <div class="modal-actions" style="margin-top: 0.75rem;">
                        <button class="modal-btn modal-btn-cancel" @onclick="() => ConfirmDownloadData(false, false)">@LocalizationService["Cancel"]</button>
                    </div>
                </div>
            </div>
        }

        <!-- ── Password Prompt Dialog ───────────────────────────────────────── -->
        @if (showPasswordPrompt)
        {
            <div class="modal-overlay">
                <div class="modal-window">
                    <h2 class="modal-title">@LocalizationService["EnterPasswordMessage"]</h2>
                    <input type="password" class="modal-input" @bind="passwordInput" placeholder="••••••••" />
                    <div class="modal-actions" style="margin-top: 1rem;">
                        <button class="modal-btn modal-btn-cancel" @onclick="CancelPasswordPrompt">@LocalizationService["Cancel"]</button>
                        <button class="modal-btn modal-btn-confirm" @onclick="ValidatePassword">@LocalizationService["Submit"]</button>
                    </div>
                </div>
            </div>
        }

        <!-- ── Offline Scans Modal ──────────────────────────────────────────── -->
        @if (showOfflineScanResultsModal)
        {
            <div class="modal-overlay">
                <div class="modal-window modal-window--wide">
                    <h2 class="modal-title">@LocalizationService["OfflineScanResultsTitle"]</h2>

                    <!-- Filters -->
                    <div class="offline-filters">
                        <input type="text" class="modal-input" style="margin-bottom: 0.5rem;"
                               placeholder="@LocalizationService["FilterByBarcode"]"
                               @bind="barcodeFilter" @bind:event="oninput" />

                        <select class="modal-input" @bind="resultFilter">
                            <option value="All">@LocalizationService["AllResults"]</option>
                            @foreach (var result in Enum.GetValues(typeof(AccreditValidation.Enums.BadgeValidationResult)))
                            {
                                <option value="@result">@Enum.GetName(typeof(AccreditValidation.Enums.BadgeValidationResult), result)</option>
                            }
                        </select>
                    </div>

                    <!-- Records -->
                    <div class="offline-records-list" id="offline_record_holder">
                        @if (FilteredRecords.Any())
                        {
                            @foreach (var record in FilteredRecords)
                            {
                                var isSuccess = (AccreditValidation.Enums.BadgeValidationResult)record.ValidationResult
                                    == AccreditValidation.Enums.BadgeValidationResult.Success;

                                <div class="offline-record @(isSuccess ? "offline-record--success" : "offline-record--danger")">
                                    <div class="offline-record-row"><strong>@LocalizationService["Name"]:</strong> @record.Badge?.Forename @record.Badge?.Surname</div>
                                    <div class="offline-record-row"><strong>@LocalizationService["Barcode"]:</strong> @record.Barcode</div>
                                    <div class="offline-record-row"><strong>@LocalizationService["Area"]:</strong> @record.AreaName</div>
                                    <div class="offline-record-row">
                                        <strong>@LocalizationService["Direction"]:</strong>
                                        @Enum.GetName(typeof(AccreditValidation.Enums.ValidationDirection), record.Direction)
                                    </div>
                                    <div class="offline-record-row">
                                        <strong>@LocalizationService["ValidationResult"]:</strong>
                                        @Enum.GetName(typeof(AccreditValidation.Enums.BadgeValidationResult), record.ValidationResult)
                                    </div>
                                    <button class="btn-danger-row" style="margin-top: 0.5rem; border-radius: 8px;" @onclick="() => DeleteOfflineRecord(record)">
                                        <i class="bi bi-trash"></i>
                                        <span>@LocalizationService["Delete"]</span>
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="offline-empty">@LocalizationService["NoOfflineRecords"]</p>
                        }
                    </div>

                    <div class="modal-actions" style="margin-top: 1rem;">
                        @if (FilteredRecords.Any())
                        {
                            <button class="modal-btn modal-btn-danger" style="margin-right: auto;" @onclick="DeleteAllOfflineRecords">
                                @LocalizationService["DeleteAll"]
                            </button>
                        }
                        <button class="modal-btn modal-btn-cancel" @onclick="CloseOfflineScanModal">@LocalizationService["Close"]</button>
                    </div>
                </div>
            </div>
        }

        <!-- ── Alert toast ──────────────────────────────────────────────────── -->
        @if (!string.IsNullOrEmpty(alertMessage))
        {
            <div class="alert-toast @(alertType == ConstantsName.AlertSuccess ? "alert-toast--success" : "alert-toast--danger")">
                <span>@alertMessage</span>
                <button class="alert-close" @onclick="() => alertMessage = string.Empty">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        }

    </div>
</AuthWrapper>
