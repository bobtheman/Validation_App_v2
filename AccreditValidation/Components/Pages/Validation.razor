@page "/Validation"

@using AccreditValidation.Shared.Constants
@using Components
@using AccreditValidation.Components.Pages.Xaml;

<AuthWrapper>
    <div class="validation-container @AppState.CustomBackgroundClass" id="validation_holder_container" @ref="validation_holder_container">

        <!-- ── NFC subtle status badge ─────────────────────────────────────── -->
        @if (IsNfcAvailable)
        {
            <div class="nfc-badge @(IsNfcListening ? "nfc-badge--active" : "")">
                <i class="bi bi-wifi nfc-badge-icon @(IsNfcListening ? "nfc-pulse" : "")"></i>
                <span>@(IsNfcListening ? LocalizationService["NfcReady"] : StatusMessage)</span>
            </div>
        }

        <!-- ── Filter card ─────────────────────────────────────────────────── -->
        <div class="settings-card">

            <!-- Card header row: Area label + collapse toggle -->
            <div class="filter-header">
                <div class="settings-card-header" style="padding: 0;">
                    <i class="bi bi-funnel card-icon"></i>
                    <span style="visibility:@(ShowFilter ? "visible" : "hidden")">@LocalizationService["Area"]</span>
                </div>
                <button class="filter-toggle-btn" @onclick="ToggleFilter"
                        title="@LocalizationService["Filter"]"
                        aria-label="@LocalizationService["Filter"]">
                    <i class="bi @(ShowFilter ? "bi-arrows-collapse" : "bi-arrows-expand")"></i>
                </button>
            </div>

            <div id="filter_holder_div" style="display:@(ShowFilter ? "block" : "none"); padding: 0 1rem 1rem;">

                <!-- Area dropdown -->
                <select class="settings-select card-select" @onchange="OnAreaChanged"
                        disabled="@(AreaList == null || AreaList.Count == 0)">
                    @if (AreaList == null || AreaList.Count == 0)
                    {
                        <option disabled selected>@LocalizationService["NoAreasAvailable"]</option>
                    }
                    else
                    {
                        @foreach (var area in AreaList)
                        {
                            <option value="@area.Identifier"
                                    selected="@(AppState.SelectedAreaIdentifier == area.Identifier ? "selected" : null)">
                                @area.Name
                            </option>
                        }
                    }
                </select>

                <div class="row-divider" style="margin: 0.5rem 0;"></div>

                <!-- Direction label -->
                <div class="settings-card-header" style="padding: 0.5rem 0 0.25rem;">
                    <i class="bi bi-arrow-left-right card-icon"></i>
                    <span>@LocalizationService["Direction"]</span>
                </div>

                <!-- Direction dropdown -->
                <select class="settings-select card-select" @onchange="OnSelectedDirectionChanged">
                    @foreach (var direction in DirectionList)
                    {
                        <option value="@direction.Identifier"
                                selected="@(AppState.SelectedDirectionIdentifier == direction.Identifier ? "selected" : null)">
                            @direction.Direction
                        </option>
                    }
                </select>

                <!-- Manual barcode input -->
                @if (UseManualInput)
                {
                    <div class="row-divider" style="margin: 0.75rem 0 0.5rem;"></div>
                    <div class="manual-input-row">
                        <input class="manual-input-field"
                               type="number"
                               @bind="BarcodeData"
                               placeholder="@LocalizationService["Barcode"]" />
                        <button @onclick="Validate" class="icon-btn icon-btn--primary">
                            <i class="bi bi-search"></i>
                        </button>
                        <button @onclick="Clear" class="icon-btn icon-btn--secondary">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                }

                <!-- Camera scan button -->
                @if (UseDeviceCameraView)
                {
                    <div style="margin-top: 0.75rem;">
                        <button class="btn-action btn-action--primary w-100" @onclick="OpenNativeCameraPage" type="button">
                            <i class="bi bi-camera"></i>
                            @LocalizationService["Scan"]
                        </button>
                    </div>
                }

            </div>
        </div>

        <!-- ── Result card ─────────────────────────────────────────────────── -->
        @if (ShowResult)
        {
            <div class="settings-card result-card" id="validation_result_holder">

                @if (ShowValidationImageDiv)
                {
                    <div class="result-image-wrap" id="validation_image_div">
                        <img src="@PhotoUrl" class="result-photo" id="validation_photo_holder" />

                        @if (AppState.CustomBackgroundClass == ConstantsName.BGCustomDanger)
                        {
                            <div id="validation_result_denied">@LocalizationService["Denied"]</div>
                            <span class="result-badge result-badge--danger">
                                <i class="bi bi-x-circle-fill"></i>
                            </span>
                        }
                        else if (AppState.CustomBackgroundClass == ConstantsName.BGCustomSuccess)
                        {
                            <span class="result-badge result-badge--success">
                                <i class="bi bi-check-circle-fill"></i>
                            </span>
                        }
                    </div>
                }

                <div class="result-details">
                    <p class="result-org">@OrganisationName</p>
                    <p class="result-subtype">@SubTypeName</p>
                    <p class="result-name">@Name</p>
                    <p class="result-meta">@Direction</p>
                    <p class="result-meta">@ValidationResultName</p>
                </div>

            </div>
        }

    </div>
</AuthWrapper>

<style>
    @@keyframes pulse {
        0%   { opacity: 1; }
        50%  { opacity: 0.35; }
        100% { opacity: 1; }
    }
</style>
